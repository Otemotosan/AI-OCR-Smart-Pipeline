============================= test session starts =============================
platform win32 -- Python 3.13.3, pytest-9.0.1, pluggy-1.6.0 -- C:\Users\user\AppData\Local\Programs\Python\Python313\python.exe
cachedir: .pytest_cache
rootdir: C:\Users\user\repositories\AI-OCR Smart Pipeline
configfile: pyproject.toml
plugins: anyio-4.11.0, asyncio-1.3.0, cov-7.0.0, mock-3.15.1, timeout-2.4.0, xdist-3.8.0
asyncio: mode=Mode.AUTO, debug=False, asyncio_default_fixture_loop_scope=None, asyncio_default_test_loop_scope=function
collecting ... collected 649 items

tests/unit/test_alerting.py::TestAlertPriority::test_priority_values PASSED [  0%]
tests/unit/test_alerting.py::TestAlertPriority::test_priority_count PASSED [  0%]
tests/unit/test_alerting.py::TestAlertStatus::test_status_values PASSED  [  0%]
tests/unit/test_alerting.py::TestAlert::test_alert_creation PASSED       [  0%]
tests/unit/test_alerting.py::TestAlert::test_alert_with_details PASSED   [  0%]
tests/unit/test_alerting.py::TestAlert::test_alert_with_runbook PASSED   [  0%]
tests/unit/test_alerting.py::TestAlert::test_alert_to_dict PASSED        [  1%]
tests/unit/test_alerting.py::TestAlert::test_alert_to_dict_resolved PASSED [  1%]
tests/unit/test_alerting.py::TestAlertConfig::test_config_creation PASSED [  1%]
tests/unit/test_alerting.py::TestSlackChannel::test_init PASSED          [  1%]
tests/unit/test_alerting.py::TestSlackChannel::test_init_default_channel PASSED [  1%]
tests/unit/test_alerting.py::TestSlackChannel::test_send_success PASSED  [  1%]
tests/unit/test_alerting.py::TestSlackChannel::test_send_with_details PASSED [  2%]
tests/unit/test_alerting.py::TestSlackChannel::test_send_failure PASSED  [  2%]
tests/unit/test_alerting.py::TestPagerDutyChannel::test_init PASSED      [  2%]
tests/unit/test_alerting.py::TestPagerDutyChannel::test_send_success PASSED [  2%]
tests/unit/test_alerting.py::TestPagerDutyChannel::test_send_with_runbook PASSED [  2%]
tests/unit/test_alerting.py::TestPagerDutyChannel::test_send_failure PASSED [  2%]
tests/unit/test_alerting.py::TestEmailChannel::test_init PASSED          [  2%]
tests/unit/test_alerting.py::TestEmailChannel::test_send_logs_only PASSED [  3%]
tests/unit/test_alerting.py::TestAlertManager::test_init_without_config PASSED [  3%]
tests/unit/test_alerting.py::TestAlertManager::test_init_with_config PASSED [  3%]
tests/unit/test_alerting.py::TestAlertManager::test_init_channels_slack PASSED [  3%]
tests/unit/test_alerting.py::TestAlertManager::test_init_channels_pagerduty PASSED [  3%]
tests/unit/test_alerting.py::TestAlertManager::test_trigger_unknown_alert PASSED [  3%]
tests/unit/test_alerting.py::TestAlertManager::test_trigger_known_alert PASSED [  4%]
tests/unit/test_alerting.py::TestAlertManager::test_get_active_alerts_empty PASSED [  4%]
tests/unit/test_alerting.py::TestAlertManager::test_resolve_unknown_alert PASSED [  4%]
tests/unit/test_alerting.py::TestConvenienceAlertFunctions::test_alert_queue_backlog_below_threshold PASSED [  4%]
tests/unit/test_alerting.py::TestConvenienceAlertFunctions::test_alert_queue_backlog_at_threshold PASSED [  4%]
tests/unit/test_alerting.py::TestConvenienceAlertFunctions::test_alert_queue_backlog_above_threshold PASSED [  4%]
tests/unit/test_alerting.py::TestConvenienceAlertFunctions::test_alert_high_failure_rate_below_threshold PASSED [  4%]
tests/unit/test_alerting.py::TestConvenienceAlertFunctions::test_alert_high_failure_rate_at_threshold PASSED [  5%]
tests/unit/test_alerting.py::TestConvenienceAlertFunctions::test_alert_pro_budget_below_threshold PASSED [  5%]
tests/unit/test_alerting.py::TestConvenienceAlertFunctions::test_alert_pro_budget_at_threshold PASSED [  5%]
tests/unit/test_alerting.py::TestConvenienceAlertFunctions::test_alert_low_confidence_below_threshold PASSED [  5%]
tests/unit/test_alerting.py::TestConvenienceAlertFunctions::test_alert_low_confidence_at_threshold PASSED [  5%]
tests/unit/test_alerting.py::TestConvenienceAlertFunctions::test_alert_saga_compensations_below_threshold PASSED [  5%]
tests/unit/test_alerting.py::TestConvenienceAlertFunctions::test_alert_saga_compensations_at_threshold PASSED [  6%]
tests/unit/test_api.py::TestModels::test_document_status_enum PASSED     [  6%]
tests/unit/test_api.py::TestModels::test_document_update_request PASSED  [  6%]
tests/unit/test_api.py::TestModels::test_document_reject_request_validation PASSED [  6%]
tests/unit/test_api.py::TestModels::test_draft_save_request PASSED       [  6%]
tests/unit/test_api.py::TestModels::test_pro_usage_response PASSED       [  6%]
tests/unit/test_api.py::TestModels::test_activity_item PASSED            [  6%]
tests/unit/test_api.py::TestModels::test_dashboard_response PASSED       [  7%]
tests/unit/test_api.py::TestModels::test_document_list_item PASSED       [  7%]
tests/unit/test_api.py::TestModels::test_paginated_response PASSED       [  7%]
tests/unit/test_api.py::TestModels::test_extraction_attempt PASSED       [  7%]
tests/unit/test_api.py::TestModels::test_migration_metadata PASSED       [  7%]
tests/unit/test_api.py::TestModels::test_document_detail_response PASSED [  7%]
tests/unit/test_api.py::TestModels::test_update_response PASSED          [  8%]
tests/unit/test_api.py::TestModels::test_approve_response PASSED         [  8%]
tests/unit/test_api.py::TestModels::test_reject_response PASSED          [  8%]
tests/unit/test_api.py::TestModels::test_draft_response PASSED           [  8%]
tests/unit/test_api.py::TestModels::test_health_response PASSED          [  8%]
tests/unit/test_api.py::TestModels::test_error_response PASSED           [  8%]
tests/unit/test_api.py::TestSettings::test_settings_dataclass PASSED     [  8%]
tests/unit/test_api.py::TestUser::test_user_dataclass PASSED             [  9%]
tests/unit/test_api.py::TestEdgeCases::test_empty_paginated_response PASSED [  9%]
tests/unit/test_api.py::TestEdgeCases::test_document_list_item_optional_fields PASSED [  9%]
tests/unit/test_api.py::TestEdgeCases::test_migration_metadata_empty_fields PASSED [  9%]
tests/unit/test_api.py::TestEdgeCases::test_dashboard_response_empty_activity PASSED [  9%]
tests/unit/test_api.py::TestEdgeCases::test_document_detail_response_minimal PASSED [  9%]
tests/unit/test_audit.py::TestAuditAction::test_document_lifecycle_actions PASSED [ 10%]
tests/unit/test_audit.py::TestAuditAction::test_review_actions PASSED    [ 10%]
tests/unit/test_audit.py::TestAuditAction::test_draft_actions PASSED     [ 10%]
tests/unit/test_audit.py::TestAuditAction::test_data_operations PASSED   [ 10%]
tests/unit/test_audit.py::TestAuditAction::test_access_events PASSED     [ 10%]
tests/unit/test_audit.py::TestAuditEntry::test_basic_entry PASSED        [ 10%]
tests/unit/test_audit.py::TestAuditEntry::test_entry_with_details PASSED [ 10%]
tests/unit/test_audit.py::TestAuditEntry::test_entry_with_client_info PASSED [ 11%]
tests/unit/test_audit.py::TestAuditEntry::test_entry_to_dict PASSED      [ 11%]
tests/unit/test_audit.py::TestAuditEntry::test_entry_timestamp_default PASSED [ 11%]
tests/unit/test_audit.py::TestAuditLogger::test_init_development PASSED  [ 11%]
tests/unit/test_audit.py::TestAuditLogger::test_init_production_with_logging_available PASSED [ 11%]
tests/unit/test_audit.py::TestAuditLogger::test_init_production_import_error PASSED [ 11%]
tests/unit/test_audit.py::TestAuditLogger::test_init_cloud_logging_exception PASSED [ 12%]
tests/unit/test_audit.py::TestAuditLogger::test_log_with_cloud_logger PASSED [ 12%]
tests/unit/test_audit.py::TestAuditLogger::test_log_basic_entry PASSED   [ 12%]
tests/unit/test_audit.py::TestAuditLogger::test_log_document_action PASSED [ 12%]
tests/unit/test_audit.py::TestAuditLogger::test_log_correction PASSED    [ 12%]
tests/unit/test_audit.py::TestAuditLogger::test_log_correction_masks_sensitive_field PASSED [ 12%]
tests/unit/test_audit.py::TestAuditLogger::test_log_approval PASSED      [ 12%]
tests/unit/test_audit.py::TestAuditLogger::test_log_rejection PASSED     [ 13%]
tests/unit/test_audit.py::TestAuditLogger::test_log_access PASSED        [ 13%]
tests/unit/test_audit.py::TestAuditLogger::test_log_access_denied PASSED [ 13%]
tests/unit/test_audit.py::TestAuditLogger::test_log_data_export PASSED   [ 13%]
tests/unit/test_audit.py::TestAuditLogger::test_log_data_export_without_date_range PASSED [ 13%]
tests/unit/test_audit.py::TestAuditLogger::test_mask_sensitive_value_string PASSED [ 13%]
tests/unit/test_audit.py::TestAuditLogger::test_mask_sensitive_value_short_string PASSED [ 14%]
tests/unit/test_audit.py::TestAuditLogger::test_mask_sensitive_value_number PASSED [ 14%]
tests/unit/test_audit.py::TestAuditLogger::test_mask_non_sensitive_value PASSED [ 14%]
tests/unit/test_audit.py::TestGetAuditLogger::test_returns_logger PASSED [ 14%]
tests/unit/test_audit.py::TestGetAuditLogger::test_returns_singleton PASSED [ 14%]
tests/unit/test_audit.py::TestAuditLogFunction::test_audit_log_with_enum PASSED [ 14%]
tests/unit/test_audit.py::TestAuditLogFunction::test_audit_log_with_string PASSED [ 14%]
tests/unit/test_audit.py::TestAuditLogFunction::test_audit_log_with_details PASSED [ 15%]
tests/unit/test_audit.py::TestAuditLogFunction::test_audit_log_unknown_action PASSED [ 15%]
tests/unit/test_bigquery_client.py::TestBigQueryConfig::test_config_creation PASSED [ 15%]
tests/unit/test_bigquery_client.py::TestBigQueryConfig::test_config_custom_tables PASSED [ 15%]
tests/unit/test_bigquery_client.py::TestBigQueryConfig::test_extractions_table_id PASSED [ 15%]
tests/unit/test_bigquery_client.py::TestBigQueryConfig::test_corrections_table_id PASSED [ 15%]
tests/unit/test_bigquery_client.py::TestSchemas::test_extraction_schema_has_required_fields PASSED [ 16%]
tests/unit/test_bigquery_client.py::TestSchemas::test_corrections_schema_has_required_fields PASSED [ 16%]
tests/unit/test_bigquery_client.py::TestSchemas::test_extraction_schema_partition_field_exists PASSED [ 16%]
tests/unit/test_bigquery_client.py::TestSchemas::test_corrections_schema_partition_field_exists PASSED [ 16%]
tests/unit/test_bigquery_client.py::TestBigQueryClientInit::test_init_with_config PASSED [ 16%]
tests/unit/test_bigquery_client.py::TestBigQueryClientInit::test_client_property PASSED [ 16%]
tests/unit/test_bigquery_client.py::TestEnsureTablesExist::test_ensure_tables_creates_both_tables PASSED [ 16%]
tests/unit/test_bigquery_client.py::TestEnsureTablesExist::test_ensure_extractions_table_handles_error PASSED [ 17%]
tests/unit/test_bigquery_client.py::TestInsertExtraction::test_insert_extraction_success PASSED [ 17%]
tests/unit/test_bigquery_client.py::TestInsertExtraction::test_insert_extraction_with_date_string PASSED [ 17%]
tests/unit/test_bigquery_client.py::TestInsertExtraction::test_insert_extraction_with_date_object PASSED [ 17%]
tests/unit/test_bigquery_client.py::TestInsertExtraction::test_insert_extraction_with_datetime_object PASSED [ 17%]
tests/unit/test_bigquery_client.py::TestInsertExtraction::test_insert_extraction_with_slash_date_format PASSED [ 17%]
tests/unit/test_bigquery_client.py::TestInsertExtraction::test_insert_extraction_with_compact_date_format PASSED [ 18%]
tests/unit/test_bigquery_client.py::TestInsertExtraction::test_insert_extraction_with_invalid_date PASSED [ 18%]
tests/unit/test_bigquery_client.py::TestInsertExtraction::test_insert_extraction_with_errors PASSED [ 18%]
tests/unit/test_bigquery_client.py::TestInsertExtraction::test_insert_extraction_api_error PASSED [ 18%]
tests/unit/test_bigquery_client.py::TestInsertCorrection::test_insert_correction_success PASSED [ 18%]
tests/unit/test_bigquery_client.py::TestInsertCorrection::test_insert_correction_bulk_edit PASSED [ 18%]
tests/unit/test_bigquery_client.py::TestInsertCorrection::test_insert_correction_with_errors PASSED [ 18%]
tests/unit/test_bigquery_client.py::TestInsertCorrection::test_insert_correction_api_error PASSED [ 19%]
tests/unit/test_bigquery_client.py::TestQueryByDateRange::test_query_by_date_range_success PASSED [ 19%]
tests/unit/test_bigquery_client.py::TestQueryByDateRange::test_query_by_date_range_with_document_type PASSED [ 19%]
tests/unit/test_bigquery_client.py::TestQueryByDateRange::test_query_by_date_range_api_error PASSED [ 19%]
tests/unit/test_bigquery_client.py::TestGetProcessingStats::test_get_processing_stats_success PASSED [ 19%]
tests/unit/test_bigquery_client.py::TestGetProcessingStats::test_get_processing_stats_empty_results PASSED [ 19%]
tests/unit/test_bigquery_client.py::TestGetProcessingStats::test_get_processing_stats_null_values PASSED [ 20%]
tests/unit/test_bigquery_client.py::TestGetProcessingStats::test_get_processing_stats_api_error PASSED [ 20%]
tests/unit/test_bigquery_client.py::TestGetCorrectionsForDocument::test_get_corrections_success PASSED [ 20%]
tests/unit/test_bigquery_client.py::TestGetCorrectionsForDocument::test_get_corrections_empty PASSED [ 20%]
tests/unit/test_bigquery_client.py::TestGetCorrectionsForDocument::test_get_corrections_api_error PASSED [ 20%]
tests/unit/test_bigquery_client.py::TestBigQueryError::test_error_creation PASSED [ 20%]
tests/unit/test_bigquery_client.py::TestBigQueryError::test_error_is_exception PASSED [ 20%]
tests/unit/test_budget.py::TestBudgetChecking::test_check_budget_no_prior_usage PASSED [ 21%]
tests/unit/test_budget.py::TestBudgetChecking::test_check_budget_within_limits PASSED [ 21%]
tests/unit/test_budget.py::TestBudgetChecking::test_check_budget_daily_limit_reached PASSED [ 21%]
tests/unit/test_budget.py::TestBudgetChecking::test_check_budget_daily_limit_exceeded PASSED [ 21%]
tests/unit/test_budget.py::TestBudgetChecking::test_check_budget_monthly_limit_reached PASSED [ 21%]
tests/unit/test_budget.py::TestBudgetChecking::test_check_budget_both_limits_exceeded PASSED [ 21%]
tests/unit/test_budget.py::TestIncrement::test_increment_pro_usage PASSED [ 22%]
tests/unit/test_budget.py::TestIncrement::test_increment_creates_atomic_operation PASSED [ 22%]
tests/unit/test_budget.py::TestGetUsage::test_get_daily_usage_no_data PASSED [ 22%]
tests/unit/test_budget.py::TestGetUsage::test_get_daily_usage_with_data PASSED [ 22%]
tests/unit/test_budget.py::TestGetUsage::test_get_monthly_usage_no_data PASSED [ 22%]
tests/unit/test_budget.py::TestGetUsage::test_get_monthly_usage_with_data PASSED [ 22%]
tests/unit/test_budget.py::TestGetUsage::test_get_daily_usage_missing_date_key PASSED [ 22%]
tests/unit/test_budget.py::TestUsageStatistics::test_get_usage_stats_no_data PASSED [ 23%]
tests/unit/test_budget.py::TestUsageStatistics::test_get_usage_stats_with_data PASSED [ 23%]
tests/unit/test_budget.py::TestUsageStatistics::test_get_usage_stats_at_limit PASSED [ 23%]
tests/unit/test_budget.py::TestUsageStatistics::test_get_usage_stats_over_limit PASSED [ 23%]
tests/unit/test_budget.py::TestTimezone::test_budget_timezone_is_jst PASSED [ 23%]
tests/unit/test_budget.py::TestTimezone::test_get_budget_date_returns_jst_date PASSED [ 23%]
tests/unit/test_budget.py::TestTimezone::test_get_budget_month_returns_jst_month PASSED [ 24%]
tests/unit/test_budget.py::TestTimezone::test_timezone_boundary_date_change PASSED [ 24%]
tests/unit/test_budget.py::TestConstants::test_pro_daily_limit PASSED    [ 24%]
tests/unit/test_budget.py::TestConstants::test_pro_monthly_limit PASSED  [ 24%]
tests/unit/test_budget.py::TestConstants::test_pro_budget_exhausted_error PASSED [ 24%]
tests/unit/test_budget.py::TestIntegrationScenarios::test_typical_usage_flow PASSED [ 24%]
tests/unit/test_budget.py::TestIntegrationScenarios::test_daily_limit_enforcement PASSED [ 24%]
tests/unit/test_budget.py::TestIntegrationScenarios::test_new_day_resets_daily_counter PASSED [ 25%]
tests/unit/test_budget.py::TestIntegrationScenarios::test_new_month_resets_monthly_counter PASSED [ 25%]
tests/unit/test_budget.py::TestFallbackBehavior::test_increment_with_import_error_fallback PASSED [ 25%]
tests/unit/test_budget.py::TestFallbackBehavior::test_reset_if_needed_no_op PASSED [ 25%]
tests/unit/test_database.py::TestDocumentStatus::test_status_values PASSED [ 25%]
tests/unit/test_database.py::TestAuditEventType::test_event_type_values PASSED [ 25%]
tests/unit/test_database.py::TestDocumentRecord::test_create_record PASSED [ 26%]
tests/unit/test_database.py::TestDocumentRecord::test_record_to_dict PASSED [ 26%]
tests/unit/test_database.py::TestDocumentRecord::test_record_from_dict PASSED [ 26%]
tests/unit/test_database.py::TestDocumentRecord::test_record_from_dict_with_invalid_status PASSED [ 26%]
tests/unit/test_database.py::TestAuditLogEntry::test_create_entry PASSED [ 26%]
tests/unit/test_database.py::TestAuditLogEntry::test_entry_to_dict PASSED [ 26%]
tests/unit/test_database.py::TestOptimisticLocking::test_optimistic_lock_error_message PASSED [ 26%]
tests/unit/test_database.py::TestDocumentNotFoundError::test_error_message PASSED [ 27%]
tests/unit/test_database.py::TestDatabaseError::test_database_error PASSED [ 27%]
tests/unit/test_database.py::TestDatabaseClientInit::test_init_with_client PASSED [ 27%]
tests/unit/test_database.py::TestDatabaseClientInit::test_collection_constants PASSED [ 27%]
tests/unit/test_database.py::TestCreateDocument::test_create_document_success PASSED [ 27%]
tests/unit/test_database.py::TestCreateDocument::test_create_document_with_status PASSED [ 27%]
tests/unit/test_database.py::TestCreateDocument::test_create_document_api_error PASSED [ 28%]
tests/unit/test_database.py::TestGetDocument::test_get_document_success PASSED [ 28%]
tests/unit/test_database.py::TestGetDocument::test_get_document_not_found PASSED [ 28%]
tests/unit/test_database.py::TestGetDocument::test_get_document_api_error PASSED [ 28%]
tests/unit/test_database.py::TestUpdateStatus::test_update_status_success PASSED [ 28%]
tests/unit/test_database.py::TestUpdateStatus::test_update_status_failed_with_message PASSED [ 28%]
tests/unit/test_database.py::TestUpdateStatus::test_update_status_not_found PASSED [ 28%]
tests/unit/test_database.py::TestUpdateStatus::test_update_status_api_error PASSED [ 29%]
tests/unit/test_database.py::TestSaveExtraction::test_save_extraction_success PASSED [ 29%]
tests/unit/test_database.py::TestSaveExtraction::test_save_extraction_not_found PASSED [ 29%]
tests/unit/test_database.py::TestSaveExtraction::test_save_extraction_api_error PASSED [ 29%]
tests/unit/test_database.py::TestLogAuditEvent::test_log_audit_event_success PASSED [ 29%]
tests/unit/test_database.py::TestLogAuditEvent::test_log_audit_event_api_error_does_not_raise PASSED [ 29%]
tests/unit/test_database.py::TestGetAuditLog::test_get_audit_log_success PASSED [ 30%]
tests/unit/test_database.py::TestGetAuditLog::test_get_audit_log_empty PASSED [ 30%]
tests/unit/test_database.py::TestGetAuditLog::test_get_audit_log_api_error PASSED [ 30%]
tests/unit/test_database.py::TestListDocuments::test_list_documents_success PASSED [ 30%]
tests/unit/test_database.py::TestListDocuments::test_list_documents_with_status_filter PASSED [ 30%]
tests/unit/test_database.py::TestListDocuments::test_list_documents_api_error PASSED [ 30%]
tests/unit/test_database.py::TestDraftOperations::test_save_draft_success PASSED [ 30%]
tests/unit/test_database.py::TestDraftOperations::test_save_draft_api_error_does_not_raise PASSED [ 31%]
tests/unit/test_database.py::TestDraftOperations::test_get_draft_success PASSED [ 31%]
tests/unit/test_database.py::TestDraftOperations::test_get_draft_not_found PASSED [ 31%]
tests/unit/test_database.py::TestDraftOperations::test_get_draft_api_error PASSED [ 31%]
tests/unit/test_database.py::TestDraftOperations::test_delete_draft_success PASSED [ 31%]
tests/unit/test_database.py::TestDraftOperations::test_delete_draft_api_error_does_not_raise PASSED [ 31%]
tests/unit/test_database.py::TestDocumentRecordTimestampHandling::test_from_dict_with_firestore_timestamp PASSED [ 32%]
tests/unit/test_database.py::TestAuditLogEntryEventHandling::test_entry_with_invalid_event_defaults PASSED [ 32%]
tests/unit/test_docai.py::TestDocumentAIResult::test_create_result PASSED [ 32%]
tests/unit/test_docai.py::TestDocumentAIResult::test_create_result_with_fragile_type PASSED [ 32%]
tests/unit/test_docai.py::TestDocumentAIClientInit::test_init_with_defaults PASSED [ 32%]
tests/unit/test_docai.py::TestDocumentAIClientInit::test_init_with_custom_location PASSED [ 32%]
tests/unit/test_docai.py::TestDocumentAIClientInit::test_init_with_processor_id PASSED [ 32%]
tests/unit/test_docai.py::TestDocumentAIClientInit::test_lazy_client_loading PASSED [ 33%]
tests/unit/test_docai.py::TestFragileTypeDetection::test_detect_fax_japanese PASSED [ 33%]
tests/unit/test_docai.py::TestFragileTypeDetection::test_detect_fax_english PASSED [ 33%]
tests/unit/test_docai.py::TestFragileTypeDetection::test_detect_handwritten PASSED [ 33%]
tests/unit/test_docai.py::TestFragileTypeDetection::test_detect_thermal_receipt PASSED [ 33%]
tests/unit/test_docai.py::TestFragileTypeDetection::test_detect_carbon_copy PASSED [ 33%]
tests/unit/test_docai.py::TestFragileTypeDetection::test_detect_low_res_scan PASSED [ 34%]
tests/unit/test_docai.py::TestFragileTypeDetection::test_no_fragile_type_detected PASSED [ 34%]
tests/unit/test_docai.py::TestFragileTypeDetection::test_case_insensitive_detection PASSED [ 34%]
tests/unit/test_docai.py::TestProcessorName::test_default_processor_name PASSED [ 34%]
tests/unit/test_docai.py::TestProcessorName::test_custom_processor_name PASSED [ 34%]
tests/unit/test_docai.py::TestMarkdownExtraction::test_extract_simple_paragraph PASSED [ 34%]
tests/unit/test_docai.py::TestMarkdownExtraction::test_extract_multiple_paragraphs PASSED [ 34%]
tests/unit/test_docai.py::TestMarkdownExtraction::test_multi_page_separator PASSED [ 35%]
tests/unit/test_docai.py::TestMarkdownExtraction::test_extract_table PASSED [ 35%]
tests/unit/test_docai.py::TestMarkdownExtraction::test_extract_empty_table PASSED [ 35%]
tests/unit/test_docai.py::TestMarkdownExtraction::test_table_cell_with_pipe PASSED [ 35%]
tests/unit/test_docai.py::TestClientProperty::test_client_initially_none PASSED [ 35%]
tests/unit/test_docai.py::TestTextExtraction::test_text_extraction_with_none_indices PASSED [ 35%]
tests/unit/test_docai.py::TestTextExtraction::test_text_extraction_with_invalid_range PASSED [ 36%]
tests/unit/test_docai.py::TestTextExtraction::test_text_extraction_out_of_bounds PASSED [ 36%]
tests/unit/test_docai.py::TestConfidenceCalculation::test_perfect_confidence PASSED [ 36%]
tests/unit/test_docai.py::TestConfidenceCalculation::test_low_page_confidence PASSED [ 36%]
tests/unit/test_docai.py::TestConfidenceCalculation::test_low_block_confidence PASSED [ 36%]
tests/unit/test_docai.py::TestConfidenceCalculation::test_minimum_confidence_across_pages PASSED [ 36%]
tests/unit/test_docai.py::TestConfidenceCalculation::test_missing_confidence_attributes PASSED [ 36%]
tests/unit/test_docai.py::TestProcessDocumentValidation::test_invalid_gcs_uri PASSED [ 37%]
tests/unit/test_docai.py::TestProcessDocumentValidation::test_valid_gcs_uri_starts_with_gs PASSED [ 37%]
tests/unit/test_docai.py::TestFragileTypesConstant::test_fragile_types_set PASSED [ 37%]
tests/unit/test_docai.py::TestFragileTypesConstant::test_fragile_patterns_dict PASSED [ 37%]
tests/unit/test_extraction.py::TestGeminiInput::test_create_basic_input PASSED [ 37%]
tests/unit/test_extraction.py::TestGeminiInput::test_create_input_with_image PASSED [ 37%]
tests/unit/test_extraction.py::TestShouldAttachImage::test_low_confidence_triggers_image PASSED [ 38%]
tests/unit/test_extraction.py::TestShouldAttachImage::test_high_confidence_no_image PASSED [ 38%]
tests/unit/test_extraction.py::TestShouldAttachImage::test_gate_failure_triggers_image PASSED [ 38%]
tests/unit/test_extraction.py::TestShouldAttachImage::test_retry_attempt_triggers_image PASSED [ 38%]
tests/unit/test_extraction.py::TestShouldAttachImage::test_fragile_type_triggers_image PASSED [ 38%]
tests/unit/test_extraction.py::TestShouldAttachImage::test_threshold_boundary PASSED [ 38%]
tests/unit/test_extraction.py::TestShouldAttachImage::test_priority_order PASSED [ 38%]
tests/unit/test_extraction.py::TestErrorClassification::test_syntax_error_json_decode PASSED [ 39%]
tests/unit/test_extraction.py::TestErrorClassification::test_syntax_error_custom PASSED [ 39%]
tests/unit/test_extraction.py::TestErrorClassification::test_semantic_error PASSED [ 39%]
tests/unit/test_extraction.py::TestErrorClassification::test_http_429_error PASSED [ 39%]
tests/unit/test_extraction.py::TestErrorClassification::test_http_429_quota_variant PASSED [ 39%]
tests/unit/test_extraction.py::TestErrorClassification::test_http_5xx_errors PASSED [ 39%]
tests/unit/test_extraction.py::TestErrorClassification::test_unknown_error PASSED [ 40%]
tests/unit/test_extraction.py::TestErrorClassification::test_case_insensitive_http_detection PASSED [ 40%]
tests/unit/test_extraction.py::TestModelSelection::test_syntax_error_flash_retry PASSED [ 40%]
tests/unit/test_extraction.py::TestModelSelection::test_syntax_error_max_retries PASSED [ 40%]
tests/unit/test_extraction.py::TestModelSelection::test_semantic_error_pro_escalation PASSED [ 40%]
tests/unit/test_extraction.py::TestModelSelection::test_semantic_error_no_budget PASSED [ 40%]
tests/unit/test_extraction.py::TestModelSelection::test_http_429_retry_with_backoff PASSED [ 40%]
tests/unit/test_extraction.py::TestModelSelection::test_http_5xx_retry_with_fixed_interval PASSED [ 41%]
tests/unit/test_extraction.py::TestModelSelection::test_unknown_error_human_review PASSED [ 41%]
tests/unit/test_extraction.py::TestModelSelection::test_flash_attempts_zero_semantic PASSED [ 41%]
tests/unit/test_extraction.py::TestConstants::test_confidence_threshold PASSED [ 41%]
tests/unit/test_extraction.py::TestConstants::test_fragile_types_defined PASSED [ 41%]
tests/unit/test_extraction.py::TestConstants::test_retry_limits_defined PASSED [ 41%]
tests/unit/test_extraction.py::TestExceptionTypes::test_syntax_validation_error PASSED [ 42%]
tests/unit/test_extraction.py::TestExceptionTypes::test_semantic_validation_error PASSED [ 42%]
tests/unit/test_extraction.py::TestExceptionTypes::test_pro_budget_exhausted_error PASSED [ 42%]
tests/unit/test_extraction.py::TestExtractionDataclasses::test_extraction_attempt_creation PASSED [ 42%]
tests/unit/test_extraction.py::TestExtractionDataclasses::test_extraction_attempt_with_error PASSED [ 42%]
tests/unit/test_extraction.py::TestExtractionDataclasses::test_extraction_result_success PASSED [ 42%]
tests/unit/test_extraction.py::TestExtractionDataclasses::test_extraction_result_failed PASSED [ 42%]
tests/unit/test_extraction.py::TestExtractWithRetry::test_successful_first_attempt PASSED [ 43%]
tests/unit/test_extraction.py::TestExtractWithRetry::test_gate_linter_failure_then_pro_success PASSED [ 43%]
tests/unit/test_extraction.py::TestExtractWithRetry::test_pro_budget_exhausted PASSED [ 43%]
tests/unit/test_extraction.py::TestExtractWithRetry::test_syntax_error_retry_then_success PASSED [ 43%]
tests/unit/test_extraction.py::TestExtractWithRetry::test_all_retries_exhausted PASSED [ 43%]
tests/unit/test_extraction.py::TestExtractWithRetry::test_flash_unexpected_error PASSED [ 43%]
tests/unit/test_extraction.py::TestExtractWithRetry::test_pro_gate_linter_failure PASSED [ 44%]
tests/unit/test_extraction.py::TestExtractWithRetry::test_pro_schema_validation_failure PASSED [ 44%]
tests/unit/test_extraction.py::TestExtractWithRetry::test_pro_syntax_error PASSED [ 44%]
tests/unit/test_extraction.py::TestExtractWithRetry::test_pro_unexpected_error PASSED [ 44%]
tests/unit/test_extraction.py::TestExtractWithRetry::test_pro_with_image_attachment PASSED [ 44%]
tests/unit/test_gate_linter.py::TestGateLinterHappyPath::test_valid_delivery_note_passes PASSED [ 44%]
tests/unit/test_gate_linter.py::TestGateLinterHappyPath::test_valid_invoice_passes PASSED [ 44%]
tests/unit/test_gate_linter.py::TestGateLinterHappyPath::test_various_valid_id_formats PASSED [ 45%]
tests/unit/test_gate_linter.py::TestManagementIdRequired::test_missing_management_id PASSED [ 45%]
tests/unit/test_gate_linter.py::TestManagementIdRequired::test_empty_string_management_id PASSED [ 45%]
tests/unit/test_gate_linter.py::TestManagementIdRequired::test_whitespace_only_management_id PASSED [ 45%]
tests/unit/test_gate_linter.py::TestManagementIdFormat::test_invalid_id_formats[AB] PASSED [ 45%]
tests/unit/test_gate_linter.py::TestManagementIdFormat::test_invalid_id_formats[ABCDE] PASSED [ 45%]
tests/unit/test_gate_linter.py::TestManagementIdFormat::test_invalid_id_formats[AAAAAAAAAAAAAAAAAAAAA] PASSED [ 46%]
tests/unit/test_gate_linter.py::TestManagementIdFormat::test_invalid_id_formats[AAAAAAAAAAAAAAAAAAAAAAAAA] PASSED [ 46%]
tests/unit/test_gate_linter.py::TestManagementIdFormat::test_invalid_id_formats[INV 001] PASSED [ 46%]
tests/unit/test_gate_linter.py::TestManagementIdFormat::test_invalid_id_formats[INV@001] PASSED [ 46%]
tests/unit/test_gate_linter.py::TestManagementIdFormat::test_invalid_id_formats[INV#001] PASSED [ 46%]
tests/unit/test_gate_linter.py::TestManagementIdFormat::test_invalid_id_formats[INV.001] PASSED [ 46%]
tests/unit/test_gate_linter.py::TestManagementIdFormat::test_invalid_id_formats[\u65e5\u672c\u8a9eID] PASSED [ 46%]
tests/unit/test_gate_linter.py::TestManagementIdFormat::test_invalid_id_formats[INV/001] PASSED [ 47%]
tests/unit/test_gate_linter.py::TestManagementIdFormat::test_invalid_id_formats[INV\\001] PASSED [ 47%]
tests/unit/test_gate_linter.py::TestCompanyNameRequired::test_missing_company_name PASSED [ 47%]
tests/unit/test_gate_linter.py::TestCompanyNameRequired::test_empty_string_company_name PASSED [ 47%]
tests/unit/test_gate_linter.py::TestCompanyNameRequired::test_whitespace_only_company_name PASSED [ 47%]
tests/unit/test_gate_linter.py::TestIssueDateValidation::test_missing_issue_date PASSED [ 47%]
tests/unit/test_gate_linter.py::TestIssueDateValidation::test_none_issue_date PASSED [ 48%]
tests/unit/test_gate_linter.py::TestIssueDateValidation::test_invalid_date_formats[2025-13-01] PASSED [ 48%]
tests/unit/test_gate_linter.py::TestIssueDateValidation::test_invalid_date_formats[2025-01-32] PASSED [ 48%]
tests/unit/test_gate_linter.py::TestIssueDateValidation::test_invalid_date_formats[invalid-date] PASSED [ 48%]
tests/unit/test_gate_linter.py::TestIssueDateValidation::test_invalid_date_formats[2025/13/01] PASSED [ 48%]
tests/unit/test_gate_linter.py::TestIssueDateValidation::test_invalid_date_formats[20250101] PASSED [ 48%]
tests/unit/test_gate_linter.py::TestIssueDateValidation::test_invalid_date_formats[01-13-2025] PASSED [ 48%]
tests/unit/test_gate_linter.py::TestIssueDateValidation::test_future_date_fails PASSED [ 49%]
tests/unit/test_gate_linter.py::TestIssueDateValidation::test_far_future_date_fails PASSED [ 49%]
tests/unit/test_gate_linter.py::TestIssueDateValidation::test_today_date_passes PASSED [ 49%]
tests/unit/test_gate_linter.py::TestIssueDateValidation::test_past_date_passes PASSED [ 49%]
tests/unit/test_gate_linter.py::TestDocumentTypeValidation::test_unknown_document_type PASSED [ 49%]
tests/unit/test_gate_linter.py::TestDocumentTypeValidation::test_empty_document_type_skipped PASSED [ 49%]
tests/unit/test_gate_linter.py::TestDateParsing::test_parse_date_object PASSED [ 50%]
tests/unit/test_gate_linter.py::TestDateParsing::test_parse_datetime_object PASSED [ 50%]
tests/unit/test_gate_linter.py::TestDateParsing::test_parse_iso_format PASSED [ 50%]
tests/unit/test_gate_linter.py::TestDateParsing::test_parse_slash_format PASSED [ 50%]
tests/unit/test_gate_linter.py::TestDateParsing::test_parse_japanese_format PASSED [ 50%]
tests/unit/test_gate_linter.py::TestDateParsing::test_parse_invalid_format PASSED [ 50%]
tests/unit/test_gate_linter.py::TestDateParsing::test_parse_none PASSED  [ 51%]
tests/unit/test_gate_linter.py::TestMultipleErrors::test_all_fields_invalid PASSED [ 51%]
tests/unit/test_gate_linter.py::TestMultipleErrors::test_two_errors PASSED [ 51%]
tests/unit/test_gate_linter.py::TestGateLinterResult::test_result_structure PASSED [ 51%]
tests/unit/test_gate_linter.py::TestGateLinterResult::test_result_with_errors PASSED [ 51%]
tests/unit/test_gemini.py::TestGeminiResponse::test_create_response PASSED [ 51%]
tests/unit/test_gemini.py::TestGeminiClient::test_initialize_client PASSED [ 51%]
tests/unit/test_gemini.py::TestGeminiClient::test_genai_lazy_loading PASSED [ 52%]
tests/unit/test_gemini.py::TestFlashModelCalls::test_call_flash_markdown_only PASSED [ 52%]
tests/unit/test_gemini.py::TestFlashModelCalls::test_call_flash_with_image PASSED [ 52%]
tests/unit/test_gemini.py::TestProModelCalls::test_call_pro_markdown_only PASSED [ 52%]
tests/unit/test_gemini.py::TestProModelCalls::test_call_pro_with_image PASSED [ 52%]
tests/unit/test_gemini.py::TestJSONParsing::test_parse_clean_json PASSED [ 52%]
tests/unit/test_gemini.py::TestJSONParsing::test_parse_json_with_markdown_fences PASSED [ 53%]
tests/unit/test_gemini.py::TestJSONParsing::test_parse_json_with_backticks_only PASSED [ 53%]
tests/unit/test_gemini.py::TestJSONParsing::test_parse_json_with_whitespace PASSED [ 53%]
tests/unit/test_gemini.py::TestJSONParsing::test_parse_invalid_json_raises_error PASSED [ 53%]
tests/unit/test_gemini.py::TestCostCalculation::test_calculate_flash_cost PASSED [ 53%]
tests/unit/test_gemini.py::TestCostCalculation::test_calculate_pro_cost PASSED [ 53%]
tests/unit/test_gemini.py::TestCostCalculation::test_pro_is_more_expensive_than_flash PASSED [ 53%]
tests/unit/test_gemini.py::TestErrorHandling::test_syntax_error_on_invalid_json PASSED [ 54%]
tests/unit/test_gemini.py::TestErrorHandling::test_syntax_error_on_invalid_json_pro PASSED [ 54%]
tests/unit/test_gemini.py::TestConstants::test_model_names PASSED        [ 54%]
tests/unit/test_gemini.py::TestConstants::test_token_estimates PASSED    [ 54%]
tests/unit/test_gemini.py::TestConstants::test_cost_constants PASSED     [ 54%]
tests/unit/test_gemini.py::TestConstants::test_pro_more_expensive_than_flash PASSED [ 54%]
tests/unit/test_gemini.py::TestExceptionTypes::test_syntax_validation_error PASSED [ 55%]
tests/unit/test_gemini.py::TestExceptionTypes::test_semantic_validation_error PASSED [ 55%]
tests/unit/test_gemini.py::TestExceptionTypes::test_pro_budget_exhausted_error PASSED [ 55%]
tests/unit/test_lock.py::TestFileHash::test_compute_file_hash PASSED     [ 55%]
tests/unit/test_lock.py::TestFileHash::test_hash_consistency PASSED      [ 55%]
tests/unit/test_lock.py::TestFileHash::test_different_content_different_hash PASSED [ 55%]
tests/unit/test_lock.py::TestFileHash::test_empty_content PASSED         [ 55%]
tests/unit/test_lock.py::TestLockAcquisition::test_acquire_new_lock PASSED [ 56%]
tests/unit/test_lock.py::TestLockAcquisition::test_acquire_completed_document_fails PASSED [ 56%]
tests/unit/test_lock.py::TestLockAcquisition::test_acquire_active_lock_fails PASSED [ 56%]
tests/unit/test_lock.py::TestLockAcquisition::test_acquire_expired_lock_succeeds PASSED [ 56%]
tests/unit/test_lock.py::TestHeartbeat::test_heartbeat_starts PASSED     [ 56%]
tests/unit/test_lock.py::TestHeartbeat::test_heartbeat_stops_on_exit PASSED [ 56%]
tests/unit/test_lock.py::TestHeartbeat::test_heartbeat_extends_lock PASSED [ 57%]
tests/unit/test_lock.py::TestHeartbeat::test_heartbeat_handles_exceptions PASSED [ 57%]
tests/unit/test_lock.py::TestContextManager::test_context_manager_yields_doc_ref PASSED [ 57%]
tests/unit/test_lock.py::TestContextManager::test_context_manager_cleans_up_on_exception PASSED [ 57%]
tests/unit/test_lock.py::TestRelease::test_release_completed PASSED      [ 57%]
tests/unit/test_lock.py::TestRelease::test_release_failed_with_error PASSED [ 57%]
tests/unit/test_lock.py::TestIntegration::test_full_lock_lifecycle PASSED [ 57%]
tests/unit/test_lock.py::TestIntegration::test_concurrent_lock_attempts PASSED [ 58%]
tests/unit/test_lock.py::TestConstants::test_lock_ttl_constant PASSED    [ 58%]
tests/unit/test_lock.py::TestConstants::test_heartbeat_interval_constant PASSED [ 58%]
tests/unit/test_lock.py::TestConstants::test_custom_ttl PASSED           [ 58%]
tests/unit/test_lock.py::TestConstants::test_custom_heartbeat_interval PASSED [ 58%]
tests/unit/test_lock.py::TestStopHeartbeat::test_stop_heartbeat_when_no_thread PASSED [ 58%]
tests/unit/test_lock.py::TestStopHeartbeat::test_stop_heartbeat_when_thread_not_alive PASSED [ 59%]
tests/unit/test_lock.py::TestStopHeartbeat::test_stop_heartbeat_when_thread_alive PASSED [ 59%]
tests/unit/test_lock.py::TestStartHeartbeat::test_start_heartbeat_creates_thread PASSED [ 59%]
tests/unit/test_lock.py::TestStartHeartbeat::test_start_heartbeat_clears_stop_event PASSED [ 59%]
tests/unit/test_logging.py::TestLogLevel::test_log_levels_are_strings PASSED [ 59%]
tests/unit/test_logging.py::TestLogLevel::test_all_log_levels_defined PASSED [ 59%]
tests/unit/test_logging.py::TestEventType::test_document_lifecycle_events PASSED [ 59%]
tests/unit/test_logging.py::TestEventType::test_lock_events PASSED       [ 60%]
tests/unit/test_logging.py::TestEventType::test_gemini_events PASSED     [ 60%]
tests/unit/test_logging.py::TestEventType::test_saga_events PASSED       [ 60%]
tests/unit/test_logging.py::TestEventType::test_api_events PASSED        [ 60%]
tests/unit/test_logging.py::TestEventType::test_review_ui_events PASSED  [ 60%]
tests/unit/test_logging.py::TestMaskValue::test_mask_none_returns_none PASSED [ 60%]
tests/unit/test_logging.py::TestMaskValue::test_mask_sensitive_string_field PASSED [ 61%]
tests/unit/test_logging.py::TestMaskValue::test_mask_short_sensitive_string PASSED [ 61%]
tests/unit/test_logging.py::TestMaskValue::test_mask_sensitive_numeric_field PASSED [ 61%]
tests/unit/test_logging.py::TestMaskValue::test_mask_company_name PASSED [ 61%]
tests/unit/test_logging.py::TestMaskValue::test_mask_phone_pattern PASSED [ 61%]
tests/unit/test_logging.py::TestMaskValue::test_mask_email_pattern PASSED [ 61%]
tests/unit/test_logging.py::TestMaskValue::test_mask_credit_card_pattern PASSED [ 61%]
tests/unit/test_logging.py::TestMaskValue::test_mask_postal_code_pattern PASSED [ 62%]
tests/unit/test_logging.py::TestMaskValue::test_non_sensitive_field_not_masked PASSED [ 62%]
tests/unit/test_logging.py::TestMaskValue::test_non_sensitive_number_not_masked PASSED [ 62%]
tests/unit/test_logging.py::TestMaskDict::test_mask_empty_dict PASSED    [ 62%]
tests/unit/test_logging.py::TestMaskDict::test_mask_simple_dict PASSED   [ 62%]
tests/unit/test_logging.py::TestMaskDict::test_mask_nested_dict PASSED   [ 62%]
tests/unit/test_logging.py::TestMaskDict::test_mask_list_in_dict PASSED  [ 63%]
tests/unit/test_logging.py::TestConfigureLogging::test_configure_development_logging PASSED [ 63%]
tests/unit/test_logging.py::TestConfigureLogging::test_configure_production_logging PASSED [ 63%]
tests/unit/test_logging.py::TestConfigureLogging::test_auto_detect_json_logs_production PASSED [ 63%]
tests/unit/test_logging.py::TestConfigureLogging::test_auto_detect_json_logs_development PASSED [ 63%]
tests/unit/test_logging.py::TestGetLogger::test_get_logger_without_name PASSED [ 63%]
tests/unit/test_logging.py::TestGetLogger::test_get_logger_with_name PASSED [ 63%]
tests/unit/test_logging.py::TestLogProcessingEvent::test_log_processing_event_with_enum PASSED [ 64%]
tests/unit/test_logging.py::TestLogProcessingEvent::test_log_processing_event_with_string PASSED [ 64%]
tests/unit/test_logging.py::TestLogProcessingEvent::test_log_processing_event_minimal PASSED [ 64%]
tests/unit/test_logging.py::TestLogApiEvent::test_log_api_event_with_user PASSED [ 64%]
tests/unit/test_logging.py::TestLogApiEvent::test_log_api_event_without_user PASSED [ 64%]
tests/unit/test_logging.py::TestLogError::test_log_error_with_exception PASSED [ 64%]
tests/unit/test_logging.py::TestLogError::test_log_error_with_string PASSED [ 65%]
tests/unit/test_logging.py::TestLogError::test_log_error_without_doc_hash PASSED [ 65%]
tests/unit/test_logging.py::TestLogContext::test_log_context_adds_fields PASSED [ 65%]
tests/unit/test_logging.py::TestLogContext::test_log_context_cleans_up PASSED [ 65%]
tests/unit/test_logging.py::TestCloudContext::test_cloud_context_from_environment PASSED [ 65%]
tests/unit/test_logging.py::TestCloudContext::test_cloud_context_with_cloud_run PASSED [ 65%]
tests/unit/test_logging.py::TestCloudContext::test_cloud_context_local PASSED [ 65%]
tests/unit/test_logging.py::TestProductionMasking::test_masking_in_production PASSED [ 66%]
tests/unit/test_logging.py::TestProductionMasking::test_no_masking_in_development PASSED [ 66%]
tests/unit/test_logging.py::TestEventTypeCoverage::test_all_event_types_are_loggable PASSED [ 66%]
tests/unit/test_logging.py::TestSensitiveFieldsCoverage::test_management_id_masked PASSED [ 66%]
tests/unit/test_logging.py::TestSensitiveFieldsCoverage::test_total_amount_masked PASSED [ 66%]
tests/unit/test_logging.py::TestSensitiveFieldsCoverage::test_tax_amount_masked PASSED [ 66%]
tests/unit/test_logging.py::TestSensitiveFieldsCoverage::test_company_name_masked PASSED [ 67%]
tests/unit/test_logging.py::TestSensitiveFieldsCoverage::test_address_masked PASSED [ 67%]
tests/unit/test_logging.py::TestSensitiveFieldsCoverage::test_email_field_masked PASSED [ 67%]
tests/unit/test_logging.py::TestSensitiveFieldsCoverage::test_bank_account_masked PASSED [ 67%]
tests/unit/test_metrics.py::TestMetricType::test_document_processing_metrics PASSED [ 67%]
tests/unit/test_metrics.py::TestMetricType::test_gemini_metrics PASSED   [ 67%]
tests/unit/test_metrics.py::TestMetricType::test_budget_metrics PASSED   [ 67%]
tests/unit/test_metrics.py::TestMetricType::test_ocr_quality_metrics PASSED [ 68%]
tests/unit/test_metrics.py::TestMetricType::test_validation_metrics PASSED [ 68%]
tests/unit/test_metrics.py::TestMetricType::test_saga_metrics PASSED     [ 68%]
tests/unit/test_metrics.py::TestMetricType::test_lock_metrics PASSED     [ 68%]
tests/unit/test_metrics.py::TestMetricType::test_api_metrics PASSED      [ 68%]
tests/unit/test_metrics.py::TestMetricType::test_review_ui_metrics PASSED [ 68%]
tests/unit/test_metrics.py::TestMetricLabels::test_empty_labels PASSED   [ 69%]
tests/unit/test_metrics.py::TestMetricLabels::test_partial_labels PASSED [ 69%]
tests/unit/test_metrics.py::TestMetricLabels::test_full_labels PASSED    [ 69%]
tests/unit/test_metrics.py::TestMetricsClient::test_init_development PASSED [ 69%]
tests/unit/test_metrics.py::TestMetricsClient::test_init_with_project_id PASSED [ 69%]
tests/unit/test_metrics.py::TestMetricsClient::test_init_production_with_monitoring_available PASSED [ 69%]
tests/unit/test_metrics.py::TestMetricsClient::test_init_production_import_error PASSED [ 69%]
tests/unit/test_metrics.py::TestMetricsClient::test_init_cloud_monitoring_exception PASSED [ 70%]
tests/unit/test_metrics.py::TestMetricsClient::test_write_to_cloud_monitoring_int_value PASSED [ 70%]
tests/unit/test_metrics.py::TestMetricsClient::test_write_to_cloud_monitoring_float_value PASSED [ 70%]
tests/unit/test_metrics.py::TestMetricsClient::test_write_to_cloud_monitoring_exception PASSED [ 70%]
tests/unit/test_metrics.py::TestMetricsClient::test_record_calls_cloud_monitoring_when_client_exists PASSED [ 70%]
tests/unit/test_metrics.py::TestMetricsClient::test_record_with_enum PASSED [ 70%]
tests/unit/test_metrics.py::TestMetricsClient::test_record_with_string PASSED [ 71%]
tests/unit/test_metrics.py::TestMetricsClient::test_record_with_labels_object PASSED [ 71%]
tests/unit/test_metrics.py::TestMetricsClient::test_record_with_labels_dict PASSED [ 71%]
tests/unit/test_metrics.py::TestMetricsClient::test_record_float_value PASSED [ 71%]
tests/unit/test_metrics.py::TestMetricsClient::test_record_processing_complete PASSED [ 71%]
tests/unit/test_metrics.py::TestMetricsClient::test_record_gemini_call_flash PASSED [ 71%]
tests/unit/test_metrics.py::TestMetricsClient::test_record_gemini_call_pro PASSED [ 71%]
tests/unit/test_metrics.py::TestMetricsClient::test_record_gemini_call_failure PASSED [ 72%]
tests/unit/test_metrics.py::TestMetricsClient::test_record_ocr_confidence_high PASSED [ 72%]
tests/unit/test_metrics.py::TestMetricsClient::test_record_ocr_confidence_low PASSED [ 72%]
tests/unit/test_metrics.py::TestMetricsClient::test_record_validation_result_passed PASSED [ 72%]
tests/unit/test_metrics.py::TestMetricsClient::test_record_validation_result_failed PASSED [ 72%]
tests/unit/test_metrics.py::TestMetricsClient::test_record_saga_execution_success PASSED [ 72%]
tests/unit/test_metrics.py::TestMetricsClient::test_record_saga_execution_with_compensation PASSED [ 73%]
tests/unit/test_metrics.py::TestMetricsClient::test_record_lock_operation_acquired PASSED [ 73%]
tests/unit/test_metrics.py::TestMetricsClient::test_record_lock_operation_failed PASSED [ 73%]
tests/unit/test_metrics.py::TestMetricsClient::test_record_api_request_success PASSED [ 73%]
tests/unit/test_metrics.py::TestMetricsClient::test_record_api_request_error PASSED [ 73%]
tests/unit/test_metrics.py::TestMetricsClient::test_record_review_action_approved PASSED [ 73%]
tests/unit/test_metrics.py::TestMetricsClient::test_record_review_action_rejected PASSED [ 73%]
tests/unit/test_metrics.py::TestMetricsClient::test_record_review_action_draft PASSED [ 74%]
tests/unit/test_metrics.py::TestMetricsClient::test_record_review_action_conflict PASSED [ 74%]
tests/unit/test_metrics.py::TestMetricsClient::test_record_budget_status PASSED [ 74%]
tests/unit/test_metrics.py::TestGetMetricsClient::test_returns_client PASSED [ 74%]
tests/unit/test_metrics.py::TestGetMetricsClient::test_returns_singleton PASSED [ 74%]
tests/unit/test_metrics.py::TestRecordMetric::test_record_with_enum PASSED [ 74%]
tests/unit/test_metrics.py::TestRecordMetric::test_record_with_labels PASSED [ 75%]
tests/unit/test_metrics.py::TestProcessingTimer::test_timer_measures_duration PASSED [ 75%]
tests/unit/test_metrics.py::TestProcessingTimer::test_timer_record PASSED [ 75%]
tests/unit/test_metrics.py::TestProcessingTimer::test_timer_stores_doc_hash PASSED [ 75%]
tests/unit/test_metrics.py::TestProcessingTimer::test_timer_default_values PASSED [ 75%]
tests/unit/test_prompts.py::TestSystemPrompts::test_multimodal_prompt_exists PASSED [ 75%]
tests/unit/test_prompts.py::TestSystemPrompts::test_multimodal_prompt_contains_priority_rules PASSED [ 75%]
tests/unit/test_prompts.py::TestSystemPrompts::test_markdown_only_prompt_exists PASSED [ 76%]
tests/unit/test_prompts.py::TestSystemPrompts::test_markdown_only_prompt_mentions_structure PASSED [ 76%]
tests/unit/test_prompts.py::TestBuildExtractionPrompt::test_markdown_only_mode PASSED [ 76%]
tests/unit/test_prompts.py::TestBuildExtractionPrompt::test_multimodal_mode PASSED [ 76%]
tests/unit/test_prompts.py::TestBuildExtractionPrompt::test_includes_schema_description PASSED [ 76%]
tests/unit/test_prompts.py::TestBuildExtractionPrompt::test_retry_context_included PASSED [ 76%]
tests/unit/test_prompts.py::TestBuildExtractionPrompt::test_no_retry_context_on_first_attempt PASSED [ 77%]
tests/unit/test_prompts.py::TestBuildCorrectionPrompt::test_includes_error_analysis_instructions PASSED [ 77%]
tests/unit/test_prompts.py::TestBuildCorrectionPrompt::test_includes_previous_output PASSED [ 77%]
tests/unit/test_prompts.py::TestBuildCorrectionPrompt::test_includes_validation_errors PASSED [ 77%]
tests/unit/test_prompts.py::TestBuildCorrectionPrompt::test_multimodal_mode_correction PASSED [ 77%]
tests/unit/test_prompts.py::TestBuildCorrectionPrompt::test_escalation_note_included PASSED [ 77%]
tests/unit/test_prompts.py::TestBuildInitialPrompt::test_markdown_only_initial PASSED [ 77%]
tests/unit/test_prompts.py::TestBuildInitialPrompt::test_multimodal_initial PASSED [ 78%]
tests/unit/test_prompts.py::TestBuildInitialPrompt::test_includes_output_instructions PASSED [ 78%]
tests/unit/test_prompts.py::TestPromptStructure::test_schema_description_valid_markdown PASSED [ 78%]
tests/unit/test_prompts.py::TestPromptStructure::test_markdown_content_properly_formatted PASSED [ 78%]
tests/unit/test_prompts.py::TestPromptStructure::test_previous_output_valid_json PASSED [ 78%]
tests/unit/test_quality_linter.py::TestYAMLLoading::test_load_existing_config PASSED [ 78%]
tests/unit/test_quality_linter.py::TestYAMLLoading::test_load_nonexistent_config PASSED [ 79%]
tests/unit/test_quality_linter.py::TestYAMLLoading::test_parse_rule_structure PASSED [ 79%]
tests/unit/test_quality_linter.py::TestYAMLLoading::test_load_custom_config PASSED [ 79%]
tests/unit/test_quality_linter.py::TestDateSequenceValidation::test_valid_date_sequence PASSED [ 79%]
tests/unit/test_quality_linter.py::TestDateSequenceValidation::test_invalid_date_sequence PASSED [ 79%]
tests/unit/test_quality_linter.py::TestDateSequenceValidation::test_date_sequence_with_missing_dates PASSED [ 79%]
tests/unit/test_quality_linter.py::TestRangeCheck::test_value_within_range PASSED [ 79%]
tests/unit/test_quality_linter.py::TestRangeCheck::test_value_exceeds_max PASSED [ 80%]
tests/unit/test_quality_linter.py::TestRangeCheck::test_value_below_min PASSED [ 80%]
tests/unit/test_quality_linter.py::TestRangeCheck::test_missing_value_skipped PASSED [ 80%]
tests/unit/test_quality_linter.py::TestVendorExistenceCheck::test_vendor_exists_placeholder PASSED [ 80%]
tests/unit/test_quality_linter.py::TestVendorExistenceCheck::test_vendor_check_caching PASSED [ 80%]
tests/unit/test_quality_linter.py::TestMultipleRules::test_multiple_warnings PASSED [ 80%]
tests/unit/test_quality_linter.py::TestMultipleRules::test_no_warnings PASSED [ 81%]
tests/unit/test_quality_linter.py::TestQualityWarning::test_warning_structure PASSED [ 81%]
tests/unit/test_quality_linter.py::TestQualityLinterResult::test_result_passed PASSED [ 81%]
tests/unit/test_quality_linter.py::TestQualityLinterResult::test_result_with_warnings PASSED [ 81%]
tests/unit/test_quality_linter.py::TestQualityRule::test_rule_structure PASSED [ 81%]
tests/unit/test_quality_linter.py::TestUnknownCondition::test_unknown_condition_skipped PASSED [ 81%]
tests/unit/test_saga.py::TestSagaStep::test_saga_step_creation PASSED    [ 81%]
tests/unit/test_saga.py::TestSagaResult::test_saga_result_success PASSED [ 82%]
tests/unit/test_saga.py::TestSagaResult::test_saga_result_failure PASSED [ 82%]
tests/unit/test_saga.py::TestSagaOrchestrator::test_all_steps_succeed PASSED [ 82%]
tests/unit/test_saga.py::TestSagaOrchestrator::test_first_step_fails_no_compensation PASSED [ 82%]
tests/unit/test_saga.py::TestSagaOrchestrator::test_second_step_fails_compensates_first PASSED [ 82%]
tests/unit/test_saga.py::TestSagaOrchestrator::test_third_step_fails_compensates_in_reverse_order PASSED [ 82%]
tests/unit/test_saga.py::TestSagaOrchestrator::test_compensation_failure_logged_but_continues PASSED [ 83%]
tests/unit/test_saga.py::TestSagaOrchestrator::test_empty_steps_list PASSED [ 83%]
tests/unit/test_saga.py::TestGenerateFailedReport::test_basic_report_generation PASSED [ 83%]
tests/unit/test_saga.py::TestGenerateFailedReport::test_report_with_saga_error PASSED [ 83%]
tests/unit/test_saga.py::TestGenerateFailedReport::test_report_with_multiple_attempts PASSED [ 83%]
tests/unit/test_saga.py::TestDocumentPersistenceSteps::test_create_all_steps PASSED [ 83%]
tests/unit/test_saga.py::TestDocumentPersistenceSteps::test_db_pending_step PASSED [ 83%]
tests/unit/test_saga.py::TestDocumentPersistenceSteps::test_db_pending_compensation PASSED [ 84%]
tests/unit/test_saga.py::TestPersistDocument::test_persist_document_success PASSED [ 84%]
tests/unit/test_saga.py::TestPersistDocument::test_persist_document_failure PASSED [ 84%]
tests/unit/test_saga.py::TestSagaFailedError::test_saga_failed_error_message PASSED [ 84%]
tests/unit/test_schemas.py::TestDeliveryNoteV1::test_valid_delivery_note_v1 PASSED [ 84%]
tests/unit/test_schemas.py::TestDeliveryNoteV1::test_missing_required_field PASSED [ 84%]
tests/unit/test_schemas.py::TestDeliveryNoteV1::test_invalid_date_type PASSED [ 85%]
tests/unit/test_schemas.py::TestDeliveryNoteV2::test_valid_delivery_note_v2 PASSED [ 85%]
tests/unit/test_schemas.py::TestDeliveryNoteV2::test_optional_payment_due_date PASSED [ 85%]
tests/unit/test_schemas.py::TestDeliveryNoteV2::test_negative_amount_rejected PASSED [ 85%]
tests/unit/test_schemas.py::TestInvoiceV1::test_valid_invoice_v1 PASSED  [ 85%]
tests/unit/test_schemas.py::TestInvoiceV1::test_negative_tax_rejected PASSED [ 85%]
tests/unit/test_schemas.py::TestGetSchema::test_get_current_schema PASSED [ 85%]
tests/unit/test_schemas.py::TestGetSchema::test_get_specific_version PASSED [ 86%]
tests/unit/test_schemas.py::TestGetSchema::test_get_invoice_schema PASSED [ 86%]
tests/unit/test_schemas.py::TestGetSchema::test_unsupported_document_type PASSED [ 86%]
tests/unit/test_schemas.py::TestGetSchema::test_invalid_version PASSED   [ 86%]
tests/unit/test_schemas.py::TestValidateNewDocument::test_current_version_allowed PASSED [ 86%]
tests/unit/test_schemas.py::TestValidateNewDocument::test_deprecated_version_rejected PASSED [ 86%]
tests/unit/test_schemas.py::TestValidateNewDocument::test_unknown_document_type PASSED [ 87%]
tests/unit/test_schemas.py::TestDeliveryNoteV1ToV2Migration::test_migration_with_all_fields PASSED [ 87%]
tests/unit/test_schemas.py::TestDeliveryNoteV1ToV2Migration::test_migration_with_defaults PASSED [ 87%]
tests/unit/test_schemas.py::TestDeliveryNoteV1ToV2Migration::test_migration_partial_defaults PASSED [ 87%]
tests/unit/test_schemas.py::TestMigrateData::test_already_current_version PASSED [ 87%]
tests/unit/test_schemas.py::TestMigrateData::test_migrate_v1_to_current PASSED [ 87%]
tests/unit/test_schemas.py::TestMigrateData::test_missing_schema_version_defaults_to_v1 PASSED [ 87%]
tests/unit/test_schemas.py::TestMigrateData::test_unknown_document_type PASSED [ 88%]
tests/unit/test_schemas.py::TestMigrateData::test_no_migration_path PASSED [ 88%]
tests/unit/test_schemas.py::TestListSchemas::test_list_all_schemas PASSED [ 88%]
tests/unit/test_schemas.py::TestGenerateSchemaDescription::test_generate_delivery_note_v1_description PASSED [ 88%]
tests/unit/test_schemas.py::TestGenerateSchemaDescription::test_generate_invoice_v1_description PASSED [ 88%]
tests/unit/test_schemas.py::TestGenerateSchemaDescription::test_private_fields_excluded PASSED [ 88%]
tests/unit/test_schemas.py::TestSchemaRegistry::test_registry_structure PASSED [ 89%]
tests/unit/test_schemas.py::TestSchemaRegistry::test_delivery_note_config PASSED [ 89%]
tests/unit/test_schemas.py::TestSchemaRegistry::test_invoice_config PASSED [ 89%]
tests/unit/test_schemas.py::TestMigrationMetadata::test_default_values PASSED [ 89%]
tests/unit/test_schemas.py::TestMigrationMetadata::test_with_values PASSED [ 89%]
tests/unit/test_storage.py::TestParseGCSPath::test_valid_path PASSED     [ 89%]
tests/unit/test_storage.py::TestParseGCSPath::test_valid_path_single_level PASSED [ 89%]
tests/unit/test_storage.py::TestParseGCSPath::test_empty_path_raises PASSED [ 90%]
tests/unit/test_storage.py::TestParseGCSPath::test_missing_gs_prefix_raises PASSED [ 90%]
tests/unit/test_storage.py::TestParseGCSPath::test_missing_blob_path_raises PASSED [ 90%]
tests/unit/test_storage.py::TestParseGCSPath::test_empty_bucket_raises PASSED [ 90%]
tests/unit/test_storage.py::TestParseGCSPath::test_empty_blob_path_raises PASSED [ 90%]
tests/unit/test_storage.py::TestGenerateDestinationPath::test_valid_path_generation PASSED [ 90%]
tests/unit/test_storage.py::TestGenerateDestinationPath::test_path_with_datetime_issue_date PASSED [ 91%]
tests/unit/test_storage.py::TestGenerateDestinationPath::test_path_with_slash_date_format PASSED [ 91%]
tests/unit/test_storage.py::TestGenerateDestinationPath::test_path_with_numeric_issue_date PASSED [ 91%]
tests/unit/test_storage.py::TestGenerateDestinationPath::test_missing_management_id_fallback_to_unknown PASSED [ 91%]
tests/unit/test_storage.py::TestGenerateDestinationPath::test_missing_company_name_fallback_to_unknown PASSED [ 91%]
tests/unit/test_storage.py::TestGenerateDestinationPath::test_missing_issue_date_uses_timestamp PASSED [ 91%]
tests/unit/test_storage.py::TestGenerateDestinationPath::test_empty_management_id_fallback_to_unknown PASSED [ 91%]
tests/unit/test_storage.py::TestGenerateDestinationPath::test_empty_company_name_fallback_to_unknown PASSED [ 92%]
tests/unit/test_storage.py::TestGenerateDestinationPath::test_empty_issue_date_uses_timestamp PASSED [ 92%]
tests/unit/test_storage.py::TestSanitizeFilename::test_basic_sanitization PASSED [ 92%]
tests/unit/test_storage.py::TestSanitizeFilename::test_removes_invalid_characters PASSED [ 92%]
tests/unit/test_storage.py::TestSanitizeFilename::test_preserves_japanese_characters PASSED [ 92%]
tests/unit/test_storage.py::TestSanitizeFilename::test_truncates_long_names PASSED [ 92%]
tests/unit/test_storage.py::TestSanitizeFilename::test_removes_multiple_underscores PASSED [ 93%]
tests/unit/test_storage.py::TestSanitizeFilename::test_strips_leading_trailing_underscores PASSED [ 93%]
tests/unit/test_storage.py::TestSanitizeFilename::test_strips_whitespace PASSED [ 93%]
tests/unit/test_storage.py::TestSanitizeFilename::test_removes_control_characters PASSED [ 93%]
tests/unit/test_storage.py::TestSanitizeFilename::test_truncate_removes_trailing_underscore PASSED [ 93%]
tests/unit/test_storage.py::TestExceptionClasses::test_invalid_gcs_path_error PASSED [ 93%]
tests/unit/test_storage.py::TestExceptionClasses::test_invalid_gcs_path_error_no_reason PASSED [ 93%]
tests/unit/test_storage.py::TestExceptionClasses::test_storage_error PASSED [ 94%]
tests/unit/test_storage.py::TestExceptionClasses::test_file_not_found_error PASSED [ 94%]
tests/unit/test_storage.py::TestCopyBlob::test_copy_blob_success PASSED  [ 94%]
tests/unit/test_storage.py::TestCopyBlob::test_copy_blob_with_progress PASSED [ 94%]
tests/unit/test_storage.py::TestCopyBlob::test_copy_blob_source_not_found PASSED [ 94%]
tests/unit/test_storage.py::TestCopyBlob::test_copy_blob_not_found_exception PASSED [ 94%]
tests/unit/test_storage.py::TestCopyBlob::test_copy_blob_google_api_error PASSED [ 95%]
tests/unit/test_storage.py::TestCopyBlob::test_copy_blob_with_custom_retry PASSED [ 95%]
tests/unit/test_storage.py::TestCopyBlob::test_copy_blob_zero_total_bytes PASSED [ 95%]
tests/unit/test_storage.py::TestDeleteBlob::test_delete_blob_success PASSED [ 95%]
tests/unit/test_storage.py::TestDeleteBlob::test_delete_blob_not_found_ignored PASSED [ 95%]
tests/unit/test_storage.py::TestDeleteBlob::test_delete_blob_not_found_raises PASSED [ 95%]
tests/unit/test_storage.py::TestDeleteBlob::test_delete_blob_google_api_error PASSED [ 95%]
tests/unit/test_storage.py::TestDeleteBlob::test_delete_blob_with_custom_retry PASSED [ 96%]
tests/unit/test_storage.py::TestFileExists::test_file_exists_true PASSED [ 96%]
tests/unit/test_storage.py::TestFileExists::test_file_exists_false PASSED [ 96%]
tests/unit/test_storage.py::TestFileExists::test_file_exists_api_error_returns_false PASSED [ 96%]
tests/unit/test_storage.py::TestUploadString::test_upload_string_success PASSED [ 96%]
tests/unit/test_storage.py::TestUploadString::test_upload_string_with_content_type PASSED [ 96%]
tests/unit/test_storage.py::TestUploadString::test_upload_string_google_api_error PASSED [ 97%]
tests/unit/test_storage.py::TestDownloadAsBytes::test_download_as_bytes_success PASSED [ 97%]
tests/unit/test_storage.py::TestDownloadAsBytes::test_download_as_bytes_not_found PASSED [ 97%]
tests/unit/test_storage.py::TestDownloadAsBytes::test_download_as_bytes_not_found_exception PASSED [ 97%]
tests/unit/test_storage.py::TestDownloadAsBytes::test_download_as_bytes_google_api_error PASSED [ 97%]
tests/unit/test_storage.py::TestListBlobs::test_list_blobs_success PASSED [ 97%]
tests/unit/test_storage.py::TestListBlobs::test_list_blobs_with_prefix PASSED [ 97%]
tests/unit/test_storage.py::TestListBlobs::test_list_blobs_with_max_results PASSED [ 98%]
tests/unit/test_storage.py::TestListBlobs::test_list_blobs_empty PASSED  [ 98%]
tests/unit/test_storage.py::TestListBlobs::test_list_blobs_google_api_error PASSED [ 98%]
tests/unit/test_storage.py::TestStorageClient::test_storage_client_init_with_client PASSED [ 98%]
tests/unit/test_storage.py::TestStorageClient::test_storage_client_init_without_client PASSED [ 98%]
tests/unit/test_storage.py::TestStorageClient::test_storage_client_copy_file PASSED [ 98%]
tests/unit/test_storage.py::TestStorageClient::test_storage_client_delete_file PASSED [ 99%]
tests/unit/test_storage.py::TestStorageClient::test_storage_client_delete_file_ignore_not_found PASSED [ 99%]
tests/unit/test_storage.py::TestStorageClient::test_storage_client_file_exists PASSED [ 99%]
tests/unit/test_storage.py::TestStorageClient::test_storage_client_generate_destination_path PASSED [ 99%]
tests/unit/test_storage.py::TestStorageClient::test_storage_client_upload_string PASSED [ 99%]
tests/unit/test_storage.py::TestStorageClient::test_storage_client_download_as_bytes PASSED [ 99%]
tests/unit/test_storage.py::TestDefaultRetry::test_default_retry_exists PASSED [100%]

============================= 649 passed in 2.72s =============================
